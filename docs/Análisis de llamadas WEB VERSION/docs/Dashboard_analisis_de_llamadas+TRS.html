<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Call Center - v1.0 </title>

  <!-- CDNs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

  <style>
    :root {
      --primary: #dc2626;
      --primary-dark: #991b1b;
      --secondary: #1e293b;
      --secondary-dark: #0f172a;
      --success: #16a34a;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --light: #f8fafc;
      --dark: #1f2937;
      --border: #e5e7eb;
      --shadow: rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, var(--light) 0%, #e2e8f0 100%);
      color: var(--secondary);
      min-height: 100vh;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Enhanced Header */
    .mega-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 20px 40px rgba(220, 38, 38, 0.15);
      position: relative;
      overflow: hidden;
    }
    
    .mega-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: pulse 6s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }
    
    .mega-header h1 {
      font-size: clamp(24px, 4vw, 36px);
      font-weight: 800;
      margin-bottom: 12px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      position: relative;
      z-index: 1;
    }
    
    .mega-sub {
      opacity: 0.9;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      position: relative;
      z-index: 1;
      font-size: 14px;
    }
    
    .badge {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.25);
      color: white;
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      transition: var(--transition);
    }

    .badge:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
    }

    /* Enhanced Control Header */
    .header {
      background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
      color: white;
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 24px;
      align-items: center;
      box-shadow: 0 8px 32px var(--shadow);
    }
    
    .header-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .header input[type=date] {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .header input[type=date]:focus {
      outline: none;
      border-color: var(--info);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .btn {
      padding: 10px 18px;
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    /* Enhanced KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .kpi-card {
      background: white;
      padding: 24px;
      border-radius: var(--radius);
      text-align: center;
      box-shadow: 0 4px 20px var(--shadow);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: var(--transition);
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--warning), var(--success));
    }
    
    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }
    
    .kpi-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .kpi-value {
      font-size: clamp(24px, 3vw, 32px);
      font-weight: 800;
      color: var(--primary);
      text-shadow: 1px 1px 2px rgba(220, 38, 38, 0.1);
    }

    /* Enhanced Alerts */
    .alerts-container { 
      margin-bottom: 20px; 
    }
    
    .alert {
      padding: 16px 20px;
      border-radius: var(--radius);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      animation: slideInAlert 0.4s ease-out;
      backdrop-filter: blur(10px);
      border-left: 4px solid;
    }

    @keyframes slideInAlert {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      color: #065f46;
      border-color: var(--success);
    }
    
    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      color: #92400e;
      border-color: var(--warning);
    }
    
    .alert-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #991b1b;
      border-color: var(--danger);
    }
    
    .alert-icon { 
      font-size: 18px; 
      flex-shrink: 0;
    }

    /* Enhanced Shift Cards */
    .shift-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    
    @media(max-width: 1024px) { 
      .shift-grid { grid-template-columns: 1fr; } 
    }
    
    .shift-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow);
      overflow: hidden;
      transition: var(--transition);
    }

    .shift-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }
    
    .shift-header {
      padding: 20px 24px;
      color: white;
      font-weight: 700;
      font-size: 16px;
      position: relative;
    }
    
    .shift-header.day {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    }
    
    .shift-header.night {
      background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
    }
    
    .shift-body {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      padding: 20px;
    }
    
    .shift-stat {
      text-align: center;
      padding: 16px 12px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--light);
      transition: var(--transition);
    }

    .shift-stat:hover {
      border-color: var(--primary);
      transform: scale(1.02);
      background: white;
    }
    
    .shift-stat .v {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .shift-stat .l {
      font-size: 11px;
      color: #64748b;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Enhanced Charts */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }
    
    .chart-card {
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow);
      border: 1px solid var(--border);
      transition: var(--transition);
      position: relative;
    }

    .chart-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }
    
    .chart-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--secondary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .chart-container {
      height: 300px;
      position: relative;
    }

    /* Enhanced Toggle Buttons */
    .pill-toggle {
      display: inline-flex;
      gap: 2px;
      background: rgba(15, 23, 42, 0.05);
      border-radius: 50px;
      padding: 4px;
    }
    
    .pill {
      background: transparent;
      color: #64748b;
      border: 0;
      padding: 6px 14px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .pill:hover:not(.active) {
      background: rgba(15, 23, 42, 0.1);
      color: var(--secondary);
    }
    
    .pill.active {
      background: var(--secondary);
      color: white;
      box-shadow: 0 2px 8px rgba(30, 41, 59, 0.25);
    }

    /* Enhanced Tables */
    .tables-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    
    @media(max-width: 1024px) { 
      .tables-grid { grid-template-columns: 1fr; } 
    }
    
    .table-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow);
      border: 1px solid var(--border);
      overflow: hidden;
      transition: var(--transition);
    }

    .table-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }
    
    .table-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      font-weight: 700;
      padding: 16px 20px;
      font-size: 14px;
    }
    
    .table-header.night {
      background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
    }
    
    .table-scroller {
      max-height: 400px;
      overflow: auto;
    }

    .table-scroller::-webkit-scrollbar {
      width: 6px;
    }

    .table-scroller::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .table-scroller::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .table-scroller::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    
    th {
      background: var(--secondary);
      color: white;
      padding: 12px 10px;
      position: sticky;
      top: 0;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 11px;
    }
    
    td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      transition: background-color 0.2s ease;
    }

    tr:hover td {
      background: rgba(59, 130, 246, 0.05);
    }
    
    .time-cell {
      background: var(--light);
      font-weight: 700;
      text-align: left !important;
      color: var(--secondary);
    }

    /* Status Messages */
    .status-message {
      padding: 16px 20px;
      border-radius: var(--radius);
      margin: 12px 0 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      border-left: 4px solid;
    }
    
    .status-success {
      background: rgba(16, 185, 129, 0.1);
      color: #065f46;
      border-color: var(--success);
    }
    
    .status-error {
      background: rgba(239, 68, 68, 0.1);
      color: #991b1b;
      border-color: var(--danger);
    }
    
    .status-info {
      background: rgba(59, 130, 246, 0.1);
      color: #1e40af;
      border-color: var(--info);
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Audit Card */
    #auditCard.collapsed { display: none; }
    
    #auditCard {
      margin-top: 24px;
      background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
      border: 2px solid rgba(245, 158, 11, 0.3);
    }

    /* Heat Map Classes */
    .heat-good {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      font-weight: 600;
      border-radius: 6px;
    }
    
    .heat-warn {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      font-weight: 600;
      border-radius: 6px;
    }
    
    .heat-bad {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
      font-weight: 600;
      border-radius: 6px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container { padding: 16px; }
      .mega-header { padding: 20px; }
      .header { 
        grid-template-columns: 1fr; 
        gap: 16px; 
      }
      .header-controls { 
        justify-content: center; 
      }
      .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
      .shift-body { grid-template-columns: repeat(2, 1fr); }
      .charts-grid { grid-template-columns: 1fr; }
      .chart-title { 
        flex-direction: column; 
        align-items: flex-start; 
      }
    }

    /* Enhanced Print Styles */
    @page { 
      size: A4 portrait; 
      margin: 15mm 10mm; 
    }
    
    @media print {
      /* Reset backgrounds and colors */
      * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      body { 
        background: white !important; 
        color: black !important;
        font-size: 11px !important;
        line-height: 1.3 !important;
      }
      
      /* Hide non-printable elements */
      .btn, #statusMessage, .header, .alerts-container, #loadingOverlay { 
        display: none !important; 
      }
      
      .container { 
        padding: 0 !important; 
        max-width: 100% !important; 
        margin: 0 !important;
      }
      
      /* Header styling */
      .mega-header {
        background: #dc2626 !important;
        color: white !important;
        padding: 15px 20px !important;
        margin-bottom: 15px !important;
        page-break-after: avoid;
        border-radius: 8px !important;
      }
      
      .mega-header h1 {
        font-size: 20px !important;
        margin-bottom: 5px !important;
      }
      
      .mega-sub {
        font-size: 12px !important;
      }
      
      /* KPI Grid - make more compact */
      .kpi-grid {
        display: grid !important;
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 8px !important;
        margin-bottom: 15px !important;
        page-break-inside: avoid;
      }
      
      .kpi-card {
        background: white !important;
        border: 1px solid #ccc !important;
        border-radius: 6px !important;
        padding: 12px 8px !important;
        text-align: center !important;
        box-shadow: none !important;
        page-break-inside: avoid;
      }
      
      .kpi-title {
        font-size: 9px !important;
        color: #666 !important;
        margin-bottom: 4px !important;
      }
      
      .kpi-value {
        font-size: 16px !important;
        color: #dc2626 !important;
        font-weight: bold !important;
      }
      
      /* Shift cards - side by side */
      .shift-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 15px !important;
        margin-bottom: 15px !important;
        page-break-inside: avoid;
      }
      
      .shift-card {
        background: white !important;
        border: 1px solid #ccc !important;
        border-radius: 6px !important;
        overflow: hidden !important;
        page-break-inside: avoid;
      }
      
      .shift-header {
        background: #333 !important;
        color: white !important;
        padding: 8px 12px !important;
        font-size: 12px !important;
        font-weight: bold !important;
      }
      
      .shift-header.day {
        background: #dc2626 !important;
      }
      
      .shift-body {
        display: grid !important;
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 4px !important;
        padding: 8px !important;
      }
      
      .shift-stat {
        text-align: center !important;
        padding: 6px 4px !important;
        border: 1px solid #eee !important;
        border-radius: 4px !important;
      }
      
      .shift-stat .v {
        font-size: 12px !important;
        font-weight: bold !important;
        color: #dc2626 !important;
      }
      
      .shift-stat .l {
        font-size: 8px !important;
        color: #666 !important;
      }
      
      /* Charts - fix overlap issue */
      .charts-grid {
        display: block !important;
        margin-bottom: 25px !important;
        page-break-after: always !important;
        clear: both !important;
      }
      
      .chart-card {
        background: white !important;
        border: 1px solid #ccc !important;
        border-radius: 4px !important;
        padding: 12px !important;
        page-break-inside: avoid;
        box-shadow: none !important;
        margin-bottom: 20px !important;
        width: 48% !important;
        float: left !important;
        position: relative !important;
        min-height: 180px !important;
      }
      
      .chart-card:nth-child(odd) {
        margin-right: 4% !important;
      }
      
      .chart-card:nth-child(3n) {
        clear: left !important;
      }
      
      .chart-title {
        font-size: 11px !important;
        font-weight: bold !important;
        margin-bottom: 8px !important;
        color: #333 !important;
        text-align: center !important;
        line-height: 1.2 !important;
      }
      
      .chart-container {
        height: 140px !important;
        position: relative !important;
        clear: none !important;
        width: 100% !important;
        overflow: hidden !important;
      }
      
      .chart-container canvas {
        max-width: 100% !important;
        max-height: 140px !important;
        position: relative !important;
        z-index: 1 !important;
      }
      
      /* Tables - ensure they start on a new space and don't interfere */
      .tables-grid {
        display: block !important;
        margin-top: 30px !important;
        margin-bottom: 20px !important;
        clear: both !important;
        page-break-before: always !important;
        width: 100% !important;
      }
      
      .table-card {
        background: white !important;
        border: 1px solid #333 !important;
        border-radius: 4px !important;
        margin-bottom: 25px !important;
        overflow: visible !important;
        page-break-inside: avoid;
        box-shadow: none !important;
        clear: both !important;
        position: relative !important;
        width: 48% !important;
        float: left !important;
      }
      
      .table-card:nth-child(odd) {
        margin-right: 4% !important;
      }
      
      .table-header {
        background: #333 !important;
        color: white !important;
        padding: 8px 10px !important;
        font-size: 12px !important;
        font-weight: bold !important;
        text-align: center !important;
        clear: both !important;
      }
      
      .table-header.night {
        background: #555 !important;
      }
      
      .table-scroller {
        max-height: none !important;
        overflow: visible !important;
        clear: both !important;
      }
      
      table {
        width: 100% !important;
        border-collapse: collapse !important;
        font-size: 12px !important;
        margin: 0 !important;
        clear: both !important;
        position: relative !important;
      }
      
      th {
        background: #f8f9fa !important;
        color: #333 !important;
        padding: 8px 6px !important;
        border: 1px solid #dee2e6 !important;
        font-weight: bold !important;
        font-size: 11px !important;
        text-align: center !important;
        position: static !important;
        line-height: 1.4 !important;
      }
      
      td {
        padding: 6px 5px !important;
        border: 1px solid #dee2e6 !important;
        text-align: center !important;
        font-size: 12px !important;
        background: white !important;
        page-break-inside: avoid;
        line-height: 1.4 !important;
      }
      
      .time-cell {
        background: #f8f9fa !important;
        font-weight: bold !important;
        text-align: center !important;
        color: #333 !important;
        font-size: 9px !important;
      }
      
      /* Force proper spacing between sections */
      .shift-grid {
        margin-bottom: 20px !important;
        page-break-after: avoid !important;
      }
      
      .kpi-grid {
        margin-bottom: 15px !important;
        page-break-after: avoid !important;
      }
      
      /* Page break management */
      .charts-grid {
        page-break-before: avoid;
        page-break-after: always;
      }
      
      .table-card:first-child {
        page-break-before: always;
      }
      
      .table-card:last-child {
        page-break-after: avoid;
      }
      
      /* Ensure no float interference */
      * {
        float: none !important;
        position: static !important;
      }
      
      /* Exception for specific print layout elements */
      .chart-card {
        float: left !important;
        position: relative !important;
      }
      
      .table-card {
        float: left !important;
        position: relative !important;
      }
      
      .chart-container canvas {
        position: relative !important;
        z-index: 1 !important;
      }
      
      /* Add clearfix after chart and table grids */
      .charts-grid::after,
      .tables-grid::after {
        content: "" !important;
        display: table !important;
        clear: both !important;
      }
      
      /* Adjust page margins for better fit */
      @page {
        size: A4 portrait;
        margin: 12mm 8mm;
      }
      
      /* Make table columns slightly wider for better readability */
      .table-card th:nth-child(1) { width: 12% !important; } /* Hora */
      .table-card th:nth-child(2) { width: 13% !important; } /* Recibidas */
      .table-card th:nth-child(3) { width: 13% !important; } /* Contestadas */
      .table-card th:nth-child(4) { width: 12% !important; } /* AVG time */
      .table-card th:nth-child(5) { width: 13% !important; } /* % Atenci√≥n */
      .table-card th:nth-child(6) { width: 13% !important; } /* Abandonadas */
      .table-card th:nth-child(7) { width: 12% !important; } /* AVG time Aband. */
      .table-card th:nth-child(8) { width: 12% !important; } /* % Abandono */
    }

    /* Loading State */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --light: #1f2937;
        --dark: #f8fafc;
        --border: #374151;
        --shadow: rgba(0, 0, 0, 0.3);
      }
      
      body {
        background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
        color: #f8fafc;
      }
      
      .kpi-card, .shift-card, .chart-card, .table-card {
        background: #1f2937;
        border-color: #374151;
      }
      
      .shift-stat {
        background: #111827;
      }
      
      .shift-stat:hover {
        background: #1f2937;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="mega-header">
      <h1>Dashboard Call Center</h1>
      <div class="mega-sub">
        <span>Sistema de monitoreo y an√°lisis de llamadas</span>
        <span id="dateRangeBadge" class="badge" style="display:none">Rango de datos: -</span>
        <span class="badge">v1.0 </span>
      </div>
    </div>

    <div class="header">
      <div class="header-controls">
        <input type="date" id="selectedDate"/>
        <input type="file" id="contestadasFile" accept=".csv,.xls,.xlsx" hidden/>
        <input type="file" id="abandonadasFile" accept=".csv,.xls,.xlsx" hidden/>
        <input type="file" id="transaccionesFile" accept=".csv,.xls,.xlsx" hidden/>
        <button class="btn" id="btnContestadas">üìû Cargar Contestadas</button>
        <button class="btn" id="btnAbandonadas">üìµ Cargar Abandonadas</button>
        <button class="btn" id="btnTransacciones">üí∞ Cargar Transacciones</button>
      </div>
      <div class="header-controls">
        <button class="btn btn-primary" id="btnDemo">üéØ Demo</button>
        <button class="btn" id="btnLimpiar">üóëÔ∏è Limpiar</button>
        <button class="btn" id="exportCsvBtn" disabled>üìä CSV</button>
        <button class="btn" id="exportXlsxBtn" disabled>üìã Excel</button>
        <button class="btn" id="btnAuditToggle">üîç Auditor√≠a</button>
        <button class="btn" id="btnPDF">üñ®Ô∏è PDF</button>
      </div>
    </div>

    <div id="statusMessage" class="status-message status-info" style="display:none">
      <div class="loading"></div>
      <span></span>
    </div>
    <div id="alertsContainer" class="alerts-container"></div>

    <!-- KPI GLOBALES -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-title">Total Recibidas</div>
        <div class="kpi-value" id="totalRecibidas">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Total Contestadas</div>
        <div class="kpi-value" id="totalContestadas">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Total Abandonadas</div>
        <div class="kpi-value" id="totalAbandonadas">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">% Atenci√≥n</div>
        <div class="kpi-value" id="nivelServicio">0%</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">% Abandono</div>
        <div class="kpi-value" id="porcAbandono">0%</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Transacciones CC</div>
        <div class="kpi-value" id="transCc">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">% Conversi√≥n</div>
        <div class="kpi-value" id="porcConversionCC">0%</div>
      </div>
    </div>

    <!-- KPI POR TURNO -->
    <div class="shift-grid">
      <div class="shift-card">
        <div class="shift-header day">Turno D√≠a (09:00-15:30)</div>
        <div class="shift-body">
          <div class="shift-stat"><div class="v" id="dayRecibidas">0</div><div class="l">Recibidas</div></div>
          <div class="shift-stat"><div class="v" id="dayContestadas">0</div><div class="l">Contestadas</div></div>
          <div class="shift-stat"><div class="v" id="dayTransCC">0</div><div class="l">Transacciones</div></div>
          <div class="shift-stat"><div class="v" id="dayConvCC">0%</div><div class="l">% Conversi√≥n</div></div>
          <div class="shift-stat"><div class="v" id="dayAbandonadas">0</div><div class="l">Abandonadas</div></div>
          <div class="shift-stat"><div class="v" id="dayDuplicadas">0</div><div class="l">Duplicadas</div></div>
          <div class="shift-stat"><div class="v" id="dayLT20">0</div><div class="l">< 20s</div></div>
          <div class="shift-stat"><div class="v" id="dayPctAtencion">0%</div><div class="l">% Atenci√≥n</div></div>
          <div class="shift-stat"><div class="v" id="dayPctAbandono">0%</div><div class="l">% Abandono</div></div>
        </div>
      </div>
      <div class="shift-card">
        <div class="shift-header night">Turno Noche (16:00-23:30)</div>
        <div class="shift-body">
          <div class="shift-stat"><div class="v" id="nightRecibidas">0</div><div class="l">Recibidas</div></div>
          <div class="shift-stat"><div class="v" id="nightContestadas">0</div><div class="l">Contestadas</div></div>
          <div class="shift-stat"><div class="v" id="nightTransCC">0</div><div class="l">Transacciones</div></div>
          <div class="shift-stat"><div class="v" id="nightConvCC">0%</div><div class="l">% Conversi√≥n</div></div>
          <div class="shift-stat"><div class="v" id="nightAbandonadas">0</div><div class="l">Abandonadas</div></div>
          <div class="shift-stat"><div class="v" id="nightDuplicadas">0</div><div class="l">Duplicadas</div></div>
          <div class="shift-stat"><div class="v" id="nightLT20">0</div><div class="l">< 20s</div></div>
          <div class="shift-stat"><div class="v" id="nightPctAtencion">0%</div><div class="l">% Atenci√≥n</div></div>
          <div class="shift-stat"><div class="v" id="nightPctAbandono">0%</div><div class="l">% Abandono</div></div>
        </div>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">% Atenci√≥n vs % Abandono por turno</div>
        <div class="chart-container"><canvas id="barsTurno"></canvas></div>
      </div>

      <!-- Por hora con toggle D√≠a/Noche -->
      <div class="chart-card">
        <div class="chart-title">
          <span>Distribuci√≥n de llamadas por hora</span>
          <div class="pill-toggle">
            <button id="btnHoraDia" class="pill active">D√≠a</button>
            <button id="btnHoraNoche" class="pill">Noche</button>
          </div>
        </div>
        <div class="chart-container"><canvas id="barHora"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">Transacciones: Call Center vs Plataformas</div>
        <div class="chart-container"><canvas id="barsPlataforma"></canvas></div>
      </div>

      <!-- Ventas totales con toggle -->
      <div class="chart-card">
        <div class="chart-title">
          <span id="titleVentas">Ventas totales: CC vs Resto de plataformas</span>
          <div class="pill-toggle">
            <button id="btnVentasAgg" class="pill active">CC vs Resto</button>
            <button id="btnVentasPlat" class="pill">CC vs Plataformas</button>
          </div>
        </div>
        <div class="chart-container"><canvas id="barVentas"></canvas></div>
      </div>

      <!-- AOV con toggle -->
      <div class="chart-card">
        <div class="chart-title">
          <span id="titleAOV">Ticket promedio: CC vs Resto de plataformas</span>
          <div class="pill-toggle">
            <button id="btnAOVAgg" class="pill active">CC vs Resto</button>
            <button id="btnAOVPlat" class="pill">CC vs Plataformas</button>
          </div>
        </div>
        <div class="chart-container"><canvas id="barAOV"></canvas></div>
      </div>

      <div class="chart-card">
        <div class="chart-title">Top 10 Sucursales por Transacciones CC</div>
        <div class="chart-container"><canvas id="barSucursalesCC"></canvas></div>
      </div>
    </div>

    <!-- Distribuci√≥n por hora (tablas) -->
    <div class="tables-grid">
      <div class="table-card">
        <div class="table-header">Turno D√≠a</div>
        <div class="table-scroller">
          <table>
            <thead>
              <tr><th>Hora</th><th>Recibidas</th><th>Contestadas</th><th>Conexi√≥n</th><th>AVG time</th><th>% Atenci√≥n</th><th>Abandonadas</th><th>Conexi√≥n</th><th>AVG time Aband.</th><th>% Abandono</th></tr>
            </thead>
            <tbody id="dayTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="table-card">
        <div class="table-header night">Turno Noche</div>
        <div class="table-scroller">
          <table>
            <thead>
              <tr><th>Hora</th><th>Recibidas</th><th>Contestadas</th><th>Conexi√≥n</th><th>AVG time</th><th>% Atenci√≥n</th><th>Abandonadas</th><th>Conexi√≥n</th><th>AVG time Aband.</th><th>% Abandono</th></tr>
            </thead>
            <tbody id="nightTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Auditor (toggle) -->
    <div class="chart-card collapsed" id="auditCard">
      <div class="chart-title">Auditor de transacciones</div>
      <div id="auditContent" style="font-size:14px;line-height:1.6;"></div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none">
    <div class="loading-spinner"></div>
  </div>

  <script>
    // Enhanced error handling and performance monitoring
    class Dashboard {
      constructor() {
        this.state = {
          answeredRows: [],
          abandonedRowsRaw: [],
          abandonedRows: [],
          transactionsRows: [],
          charts: {},
          dateRange: null,
          showAudit: false,
          lastAuditAll: null,
          lastAuditValid: null,
          hourTurn: 'dia',
          lastGrouped: null,
          salesMode: 'agg',
          aovMode: 'agg',
          isLoading: false
        };
        
        this.performance = {
          start: Date.now(),
          marks: {},
          mark: (name) => {
            this.performance.marks[name] = Date.now() - this.performance.start;
          }
        };
        
        this.init();
      }

      // Utility functions
      toNumber(v) { 
        if (v == null || v === '') return 0; 
        const s = String(v).trim().replace(/,/g, '.'); 
        const m = s.match(/-?\d+(?:\.\d+)?/); 
        return m ? Number(m[0]) : 0; 
      }
      
      safeFixed(v, d) { 
        return (v != null && !isNaN(v)) ? Number(v).toFixed(d) : '0'; 
      }
      
      fmt(n) { 
        return (n == null || isNaN(n)) ? '0' : new Intl.NumberFormat('es-ES').format(n); 
      }
      
      getFileExtension(filename) { 
        const a = filename.split('.'); 
        return a[a.length - 1].toLowerCase(); 
      }

      // Enhanced status display
      showStatus(msg, type = 'info', showLoader = false) {
        const el = document.getElementById('statusMessage');
        const span = el.querySelector('span');
        const loader = el.querySelector('.loading');
        
        el.className = `status-message status-${type}`;
        if (span) span.textContent = msg;
        el.style.display = 'flex';
        
        if (showLoader && loader) {
          loader.style.display = 'inline-block';
        } else if (loader) {
          loader.style.display = 'none';
        }
        
        this.state.isLoading = !!showLoader;
        
        if (type === 'success') {
          setTimeout(() => { 
            el.style.opacity = '0';
            setTimeout(() => {
              el.style.display = 'none';
              el.style.opacity = '1';
            }, 300);
          }, 3000); 
        }
      }

      showLoading(show = true) {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.style.display = show ? 'flex' : 'none';
        }
      }

      // Enhanced file parsing with better error handling
      async parseCSV(file) { 
        return new Promise((resolve) => { 
          this.performance.mark('parseCSV_start');
          Papa.parse(file, {
            header: true, 
            skipEmptyLines: true,
            dynamicTyping: true,
            transformHeader: (header) => header.trim().toLowerCase(),
            complete: (result) => {
              this.performance.mark('parseCSV_end');
              console.log('CSV parsed in', this.performance.marks.parseCSV_end - this.performance.marks.parseCSV_start, 'ms');
              resolve(result.data);
            },
            error: (error) => {
              console.error('CSV parse error:', error);
              resolve([]);
            }
          }); 
        }); 
      }

      async parseXLS(file) { 
        return new Promise((resolve) => { 
          this.performance.mark('parseXLS_start');
          const reader = new FileReader(); 
          reader.onload = (e) => { 
            try { 
              const data = new Uint8Array(e.target.result); 
              const wb = XLSX.read(data, {type: 'array', raw: false}); 
              const ws = wb.Sheets[wb.SheetNames[0]]; 
              const arr = XLSX.utils.sheet_to_json(ws, {
                header: 1, 
                defval: '', 
                blankrows: false, 
                raw: false
              }); 
              
              if (!arr.length) return resolve([]);
              
              const headers = arr[0].map(h => String(h || '').trim().toLowerCase());
              const rows = arr.slice(1)
                .map(row => { 
                  const obj = {}; 
                  headers.forEach((h, i) => { 
                    obj[h] = String(row[i] || '').trim(); 
                  }); 
                  return obj; 
                })
                .filter(r => Object.values(r).some(v => v !== '')); 
              
              this.performance.mark('parseXLS_end');
              console.log('XLS parsed in', this.performance.marks.parseXLS_end - this.performance.marks.parseXLS_start, 'ms');
              resolve(rows); 
            } catch (e) { 
              console.error('XLS parse error:', e);
              resolve([]); 
            } 
          }; 
          reader.onerror = () => resolve([]);
          reader.readAsArrayBuffer(file); 
        }); 
      }

      async parseFile(file) {
        const ext = this.getFileExtension(file.name);
        let data = [];
        try { 
          if (ext === 'csv') data = await this.parseCSV(file); 
          else if (ext === 'xls' || ext === 'xlsx') data = await this.parseXLS(file); 
        } catch (e) { 
          this.showStatus(`Error leyendo ${file.name}: ${e.message}`, 'error'); 
          return []; 
        }
        if (!data || !data.length) { 
          this.showStatus(`${file.name} no contiene filas legibles`, 'error'); 
        }
        return data;
      }

      // Time and date utilities
      fixHora(h) {
        if (!h) return '00:00:00';
        const s = String(h).trim();
        try {
          if (/^\d{1,2}:\d{1,2}(:\d{1,2})?$/.test(s)) {
            const [H = '0', M = '0', S = '0'] = s.split(':');
            return `${String(+H).padStart(2, '0')}:${String(+M).padStart(2, '0')}:${String(+S).padStart(2, '0')}`;
          }
          if (/^\d{1,2}$/.test(s)) return `${String(+s).padStart(2, '0')}:00:00`;
          
          const dt = new Date('1970-01-01T' + s);
          if (!isNaN(dt)) {
            return `${String(dt.getHours()).padStart(2, '0')}:${String(dt.getMinutes()).padStart(2, '0')}:${String(dt.getSeconds()).padStart(2, '0')}`;
          }
        } catch (e) {}
        return '00:00:00';
      }

      periodo30(hhmmss) { 
        const [hh, mm] = this.fixHora(hhmmss).split(':').map(Number);
        return mm < 30 ? `${String(hh).padStart(2, '0')}:00` : `${String(hh).padStart(2, '0')}:30`; 
      }

      turno(h) { 
        const hh = +this.fixHora(h).split(':')[0]; 
        if (hh >= 9 && hh < 16) return 'dia'; 
        if (hh >= 16) return 'noche'; 
        return 'fuera'; 
      }

      // Initialize the dashboard
      init() {
        document.addEventListener('DOMContentLoaded', () => this.onLoad());
        
        // Enhanced error handling
        window.addEventListener('error', (e) => {
          console.error('Dashboard Error:', e);
          this.showAlert('Error en la aplicaci√≥n: ' + e.message, 'danger');
        });

        window.addEventListener('unhandledrejection', (e) => {
          console.error('Unhandled Promise Rejection:', e);
          this.showAlert('Error procesando datos: ' + e.reason, 'danger');
        });
      }

      showAlert(message, type = 'info', autoHide = true) {
        const container = document.getElementById('alertsContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        
        const icons = {
          success: '‚úÖ',
          warning: '‚ö†Ô∏è',
          danger: 'üö®',
          info: '‚ÑπÔ∏è'
        };
        
        alert.innerHTML = `
          <span class="alert-icon">${icons[type] || '‚ÑπÔ∏è'}</span>
          <span>${message}</span>
        `;
        
        container.prepend(alert);
        
        if (autoHide) {
          setTimeout(() => {
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 300);
          }, 5000);
        }
      }

      onLoad() {
        this.performance.mark('onLoad_start');
        
        // Set current date
        document.getElementById('selectedDate').value = new Date().toISOString().slice(0, 10);
        
        this.setupEventListeners();
        this.setupAuditToggle();
        this.setupChartToggles();
        
        this.performance.mark('onLoad_end');
        console.log('Dashboard loaded in', this.performance.marks.onLoad_end - this.performance.marks.onLoad_start, 'ms');
      }

      setupEventListeners() {
        // File upload handlers
        document.getElementById('btnContestadas').onclick = () => document.getElementById('contestadasFile').click();
        document.getElementById('btnAbandonadas').onclick = () => document.getElementById('abandonadasFile').click();
        document.getElementById('btnTransacciones').onclick = () => document.getElementById('transaccionesFile').click();

        // Action handlers
        document.getElementById('btnDemo').onclick = () => this.loadDemo();
        document.getElementById('btnPDF').onclick = () => this.printPDF();
        document.getElementById('btnLimpiar').onclick = () => this.clearData();

        // Export handlers
        document.getElementById('exportCsvBtn').onclick = () => this.exportCSV();
        document.getElementById('exportXlsxBtn').onclick = () => this.exportXLSX();

        // File input listeners
        document.getElementById('contestadasFile').addEventListener('change', (e) => this.handleContestadas(e));
        document.getElementById('abandonadasFile').addEventListener('change', (e) => this.handleAbandonadas(e));
        document.getElementById('transaccionesFile').addEventListener('change', (e) => this.handleTransacciones(e));
      }

      setupAuditToggle() {
        const urlHasAudit = /[?&]audit=1\b/i.test(location.search);
        const saved = localStorage.getItem('showAudit') === '1';
        this.state.showAudit = urlHasAudit || saved;
        this.applyAuditVisibility();

        document.getElementById('btnAuditToggle').onclick = () => {
          this.state.showAudit = !this.state.showAudit;
          localStorage.setItem('showAudit', this.state.showAudit ? '1' : '0');
          this.applyAuditVisibility();
          
          if (this.state.showAudit && this.state.lastAuditValid) {
            this.auditTransacciones(this.state.lastAuditAll || this.state.transactionsRows, this.state.lastAuditValid);
          } else {
            const el = document.getElementById('auditContent'); 
            if (el) el.innerHTML = '';
          }
        };
      }

      setupChartToggles() {
        // Hour toggle
        document.getElementById('btnHoraDia').onclick = () => this.toggleHour('dia');
        document.getElementById('btnHoraNoche').onclick = () => this.toggleHour('noche');

        // Sales toggle
        document.getElementById('btnVentasAgg').onclick = () => this.toggleSales('agg');
        document.getElementById('btnVentasPlat').onclick = () => this.toggleSales('plat');

        // AOV toggle
        document.getElementById('btnAOVAgg').onclick = () => this.toggleAOV('agg');
        document.getElementById('btnAOVPlat').onclick = () => this.toggleAOV('plat');
      }

      toggleHour(mode) {
        if (this.state.hourTurn === mode) return;
        
        this.state.hourTurn = mode;
        document.getElementById('btnHoraDia').className = `pill ${mode === 'dia' ? 'active' : ''}`;
        document.getElementById('btnHoraNoche').className = `pill ${mode === 'noche' ? 'active' : ''}`;
        
        if (this.state.lastGrouped) this.drawHourly(this.state.lastGrouped);
      }

      toggleSales(mode) {
        if (this.state.salesMode === mode) return;
        this.state.salesMode = mode;
        document.getElementById('btnVentasAgg').className = `pill ${mode === 'agg' ? 'active' : ''}`;
        document.getElementById('btnVentasPlat').className = `pill ${mode === 'plat' ? 'active' : ''}`;
        document.getElementById('titleVentas').textContent = mode === 'agg' ? 'Ventas totales: CC vs Resto' : 'Ventas totales: CC vs Plataformas';
        this.drawSalesChart();
      }

      toggleAOV(mode) {
        if (this.state.aovMode === mode) return;
        this.state.aovMode = mode;
        document.getElementById('btnAOVAgg').className = `pill ${mode === 'agg' ? 'active' : ''}`;
        document.getElementById('btnAOVPlat').className = `pill ${mode === 'plat' ? 'active' : ''}`;
        document.getElementById('titleAOV').textContent = mode === 'agg' ? 'Ticket promedio: CC vs Resto' : 'Ticket promedio: CC vs Plataformas';
        this.drawAOVChart();
      }

      printPDF() {
        this.showStatus('Preparando para imprimir...', 'info', true);
        setTimeout(() => {
          window.print(); 
          this.showStatus('Listo para imprimir', 'success');
        }, 500);
      }

      clearData() {
        if (this.state.answeredRows.length === 0 && this.state.abandonedRowsRaw.length === 0 && this.state.transactionsRows.length === 0) {
          this.showStatus('No hay datos para limpiar.', 'info');
          return;
        }

        Object.assign(this.state, {
          answeredRows: [],
          abandonedRowsRaw: [],
          abandonedRows: [],
          transactionsRows: [],
          dateRange: null,
          lastAuditAll: null,
          lastAuditValid: null
        });

        // Clear file inputs
        ['contestadasFile', 'abandonadasFile', 'transaccionesFile'].forEach(id => {
          document.getElementById(id).value = '';
        });

        document.getElementById('dateRangeBadge').style.display = 'none';
        document.getElementById('alertsContainer').innerHTML = '';
        document.getElementById('auditContent').innerHTML = '';

        this.process();
        this.showStatus('Datos limpiados. Puede cargar nuevos archivos.', 'success');
      }

      applyAuditVisibility() {
        const card = document.getElementById('auditCard');
        const btn = document.getElementById('btnAuditToggle');
        if (!card || !btn) return;
        
        if (this.state.showAudit) {
          card.classList.remove('collapsed');
          btn.textContent = 'üîç Ocultar auditor√≠a';
        } else {
          card.classList.add('collapsed');
          btn.textContent = 'üîç ';
        }
      }

      // Main processing logic continues...
      process() {
        this.performance.mark('process_start');
        const kpis = this.calculateKPIs();
        const grouped = this.aggregateBySlot(kpis.answeredRows, kpis.abandonedRows);
        this.state.lastGrouped = grouped;
        
        this.updateKPIs(kpis);
        this.drawCharts(kpis, grouped);
        this.drawHourly(grouped);
        this.drawSalesChart();
        this.drawAOVChart();

        const hasData = (kpis.totalContestadas > 0 || kpis.totalAbandonadas > 0 || kpis.transCCCount > 0);
        document.getElementById('exportCsvBtn').disabled = !hasData;
        document.getElementById('exportXlsxBtn').disabled = !hasData;
        
        this.performance.mark('process_end');
        console.log('Process complete in', this.performance.marks.process_end - this.performance.marks.process_start, 'ms');
      }

      // Load demo data for testing
      loadDemo() {
        this.showLoading(true);
        this.showStatus('Cargando datos demo...', 'info');
        
        setTimeout(() => {
          this.state.answeredRows = [
            {dst: '809', fecha: '2025-09-16', periodo: '09:00-09:29', hora: '09:15:00', llamadas: 15, conexion: 180},
            {dst: '809', fecha: '2025-09-16', periodo: '10:30-10:59', hora: '10:45:00', hora: '10:45:00', llamadas: 45, conexion: 240},
            {dst: '809', fecha: '2025-09-16', periodo: '11:00-11:29', hora: '11:10:00', llamadas: 67, conexion: 220},
            {dst: '809', fecha: '2025-09-16', periodo: '12:00-12:29', hora: '12:10:00', llamadas: 89, conexion: 310},
            {dst: '809', fecha: '2025-09-16', periodo: '16:00-16:29', hora: '16:15:00', llamadas: 34, conexion: 220},
            {dst: '809', fecha: '2025-09-16', periodo: '19:30-19:59', hora: '19:35:00', llamadas: 56, conexion: 280}
          ];
          
          this.state.abandonedRows = [
            {telefono: '8291234567', fecha: '2025-09-16', hora: '11:05:00', conexion: 45, turno: 'dia'},
            {telefono: '8297654321', fecha: '2025-09-16', hora: '16:30:00', conexion: 50, turno: 'noche'},
            {telefono: '8293456789', fecha: '2025-09-16', hora: '20:15:00', conexion: 35, turno: 'noche'}
          ];

          this.state.abandonedRowsRaw = this.state.abandonedRows.map(x => ({...x, isDuplicate: false, isLT20: false}));
          
          this.state.transactionsRows = [
            {plataforma: 'Call Center', sucursal: 'Sucursal Centro', canalReal: 'Delivery', fecha: '2025-09-16', hora: '11:18:00', estatus: 'N', valor: 1250},
            {plataforma: 'Call Center', sucursal: 'Sucursal Norte', canalReal: 'Carryout', fecha: '2025-09-16', hora: '12:10:00', estatus: 'N', valor: 980},
            {plataforma: 'App', sucursal: 'Sucursal Sur', canalReal: 'Carryout', fecha: '2025-09-16', hora: '19:40:00', estatus: 'N', valor: 750},
            {plataforma: 'Web', sucursal: 'Sucursal Este', canalReal: 'Delivery', fecha: '2025-09-16', hora: '10:40:00', estatus: 'N', valor: 650},
            {plataforma: 'Agregadores', sucursal: 'Sucursal Oeste', canalReal: 'Agregador', fecha: '2025-09-16', hora: '19:50:00', estatus: 'N', valor: 540}
          ];

          this.updateDateRange(); 
          this.process();
          
          this.state.lastAuditAll = this.state.transactionsRows;
          this.state.lastAuditValid = this.state.transactionsRows;
          
          if (this.state.showAudit) { 
            this.auditTransacciones(this.state.transactionsRows, this.state.transactionsRows); 
          }
          
          this.showLoading(false);
          this.showStatus('Demo cargada exitosamente', 'success');
        }, 1000);
      }

      // File handling methods
      async handleContestadas(e) {
        const file = e.target.files && e.target.files[0]; 
        if (!file) return;
        
        this.showStatus('Procesando contestadas...', 'info', true);
        
        try {
          const raw = await this.parseFile(file);
          const cleaned = raw.map(r => {
            const m = this.mapExcelFields(r, true);
            return { 
              dst: String(m.dst || '').trim(), 
              fecha: String(m.fecha || '').trim(), 
              periodo: String(m.periodo || '').trim(), 
              hora: this.fixHora(m.hora), 
              llamadas: this.toNumber(m.llamadas), 
              conexion: this.toNumber(m.conexion) 
            };
          }).filter(r => r.dst !== '8095330202' && (r.llamadas > 0 || r.conexion > 0));
          
          this.state.answeredRows = cleaned;
          this.showStatus(`Contestadas: ${cleaned.length} registros`, 'success');
          this.process(); 
          this.updateDateRange();
        } catch (err) { 
          this.showStatus(`Error procesando contestadas: ${err.message}`, 'error'); 
        }
      }

      async handleAbandonadas(e) {
        const file = e.target.files && e.target.files[0]; 
        if (!file) return;
        
        this.showStatus('Procesando abandonadas...', 'info', true);
        
        try {
          const raw = await this.parseFile(file);
          const cleanedRaw = raw.map(r => {
            const m = this.mapExcelFields(r, false); 
            const h = this.fixHora(m.hora);
            return { 
              telefono: String(m.telefono || '').trim(), 
              fecha: String(m.fecha || '').trim(), 
              hora: h, 
              conexion: this.toNumber(m.conexion), 
              periodo: this.periodo30(h), 
              turno: this.turno(h), 
              disposition: String(m.disposition || '').trim() 
            };
          }).filter(r => r.telefono !== '' || r.conexion > 0);

          const telCount = new Map(); 
          cleanedRaw.forEach(r => { 
            const k = r.telefono || ''; 
            telCount.set(k, (telCount.get(k) || 0) + 1); 
          });
          
          const duplicadasSet = new Set(cleanedRaw.filter(r => 
            r.telefono && ((telCount.get(r.telefono) || 0) > 1)
          ).map(r => `${r.telefono}|${r.fecha}|${r.hora}|${r.conexion}`));

          const sinDup = cleanedRaw.filter(r => 
            !duplicadasSet.has(`${r.telefono}|${r.fecha}|${r.hora}|${r.conexion}`)
          );
          
          const lt20Set = new Set(sinDup.filter(r => (r.conexion || 0) < 20)
            .map(r => `${r.telefono}|${r.fecha}|${r.hora}|${r.conexion}`));
          
          const finales = cleanedRaw.filter(r => {
            const key = `${r.telefono}|${r.fecha}|${r.hora}|${r.conexion}`;
            return !duplicadasSet.has(key) && !lt20Set.has(key);
          });

          this.state.abandonedRowsRaw = cleanedRaw.map(x => {
            const key = `${x.telefono}|${x.fecha}|${x.hora}|${x.conexion}`;
            return Object.assign({}, x, { 
              isDuplicate: duplicadasSet.has(key), 
              isLT20: lt20Set.has(key) 
            });
          });
          this.state.abandonedRows = finales;

          this.showStatus(`Abandonadas: ${cleanedRaw.length} (limpias: ${finales.length})`, 'success');
          this.process(); 
          this.updateDateRange();
        } catch (err) { 
          this.showStatus(`Error procesando abandonadas: ${err.message}`, 'error'); 
        }
      }

      async handleTransacciones(e) {
        const file = e.target.files && e.target.files[0]; 
        if (!file) return;
        
        this.showStatus('Procesando transacciones...', 'info', true);
        
        try {
          const raw = await this.parseFile(file);
          const all = [];
          
          for (let i = 0; i < raw.length; i++) {
            try { 
              all.push(this.mapTransFields(raw[i])); 
            } catch (err) {
              this.showAlert(`Fila ${i + 2} rota en transacciones`, 'danger');
            }
          }
          
          const cleaned = all.filter(r => r.estatus !== 'A');
          
          this.state.transactionsRows = cleaned;
          this.showStatus(`Transacciones v√°lidas: ${cleaned.length}`, 'success');
          this.process();
          
          this.state.lastAuditAll = all;
          this.state.lastAuditValid = cleaned;
          
          if (this.state.showAudit) { 
            this.auditTransacciones(all, cleaned); 
          } else { 
            const el = document.getElementById('auditContent'); 
            if (el) el.innerHTML = ''; 
          }
        } catch (err) { 
          this.showStatus(`Error procesando transacciones: ${err.message}`, 'error'); 
        }
      }

      // Field mapping methods
      mapExcelFields(rawRow, isAnswered) {
        const mapped = {};
        const nrow = {};
        Object.keys(rawRow).forEach(k => { 
          nrow[k.toLowerCase().replace(/[^a-z0-9]/g, '')] = rawRow[k]; 
        });
        
        const findValue = (keys) => {
          for (const key of keys) { 
            const nk = key.replace(/[^a-z0-9]/g, ''); 
            if (Object.prototype.hasOwnProperty.call(nrow, nk)) return nrow[nk]; 
          }
          return null;
        };
        
        if (isAnswered) {
          mapped.dst = findValue(['dst', 'destino', 'troncal', 'destination']) || '';
          mapped.fecha = findValue(['fecha', 'date', 'dia']) || '';
          mapped.periodo = findValue(['periodo', 'slot', 'horario']) || '';
          mapped.hora = findValue(['hora', 'time', 'tiempo']) || '';
          mapped.llamadas = this.toNumber(findValue(['llamadas', 'calls', 'count', 'cantidad']));
          mapped.conexion = this.toNumber(findValue(['conexion', 'coneccion', 'tiempo', 'duracion', 'duration']));
        } else {
          mapped.telefono = findValue(['telefono', 'phone', 'callerid', 'numero']) || '';
          mapped.fecha = findValue(['fecha', 'date', 'dia']) || '';
          mapped.hora = findValue(['hora', 'time', 'tiempo']) || '';
          mapped.conexion = this.toNumber(findValue(['conexion', 'coneccion', 'tiempo', 'duracion', 'duration']));
          mapped.disposition = findValue(['disposition', 'estado', 'status']) || '';
        }
        return mapped;
      }

      mapTransFields(rawRow) {
        const nrow = {};
        Object.keys(rawRow).forEach(k => {
          const nk = k.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9_]/g, '');
          nrow[nk] = String(rawRow[k] || '').trim();
        });
        
        const get = (names) => {
          for (const nm of names) { 
            if (Object.prototype.hasOwnProperty.call(nrow, nm)) return nrow[nm]; 
          } 
          return ''; 
        };
        
        const sucursal = get(['nom_unidad', 'nomunidad', 'sucursal', 'tienda']);
        const tipoFac = get(['tipo_fac', 'tipofac']);
        const plataforma = (get(['canal', 'plataforma']) || '').toUpperCase();
        const fechaRaw = get(['fecha', 'date', 'dia']);
        const horaRaw = get(['hora', 'time', 'tiempo']);
        const estatus = (get(['estatuscc', 'estatus', 'estado']) || '').toUpperCase();
        const valor = this.toNumber(get(['valor', 'monto', 'total']));
        
        const PLATFORM_LABELS = { 
          CC: 'Call Center', 
          APP: 'App', 
          WA: 'WhatsApp', 
          WEB: 'Web', 
          AG: 'Agregadores' 
        };

        const resolveCanalReal = (tipoFacRaw, plataformaCode) => {
          if (String(plataformaCode || '').toUpperCase() === 'AG') return 'Agregador';
          const v = String(tipoFacRaw || '').toUpperCase();
          if (v === 'D') return 'Delivery';
          if (v === 'C') return 'Carryout';
          return v || '';
        };
        
        return {
          sucursal: sucursal,
          canalReal: resolveCanalReal(tipoFac, plataforma),
          plataforma: PLATFORM_LABELS[plataforma] || plataforma || 'Sin plataforma',
          plataformaCode: plataforma || '',
          fecha: this.normalizeDate(fechaRaw),
          hora: this.fixHora(horaRaw),
          estatus: estatus,
          valor: valor
        };
      }

      normalizeDate(d) {
        if (!d) return '';
        const s = String(d).trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        const m = s.match(/^(\d{1,2})-([A-Za-z]{3,4})-(\d{2,4})$/);
        if (m) {
          const day = ('0' + m[1]).slice(-2);
          const monStr = m[2].toLowerCase();
          const monMap = {
            jan: '01', ene: '01', feb: '02', mar: '03', apr: '04', abr: '04',
            may: '05', jun: '06', jul: '07', aug: '08', ago: '08', sep: '09',
            sept: '09', set: '09', oct: '10', nov: '11', dec: '12', dic: '12'
          };
          const mon = monMap[monStr] || '01'; 
          let year = m[3]; 
          if (year.length === 2) { 
            year = (+year >= 70 ? '19' + year : '20' + year); 
          }
          return year + '-' + mon + '-' + day;
        }
        const dt = new Date(s); 
        if (!isNaN(dt)) return dt.toISOString().slice(0, 10);
        return s;
      }

      updateDateRange() {
        const dates = [];
        this.state.answeredRows.forEach(r => { 
          if (r.fecha) dates.push(new Date(r.fecha)); 
        });
        this.state.abandonedRows.forEach(r => { 
          if (r.fecha) dates.push(new Date(r.fecha)); 
        });
        
        if (dates.length) {
          const ms = dates.map(d => +d);
          const min = new Date(Math.min(...ms));
          const max = new Date(Math.max(...ms));
          this.state.dateRange = {min: min, max: max};
          
          const badge = document.getElementById('dateRangeBadge');
          badge.textContent = `Rango de datos: ${min.toISOString().slice(0, 10)} a ${max.toISOString().slice(0, 10)}`;
          badge.style.display = '';
        }
      }

      // KPI calculation
      calculateKPIs() {
        const totalAnswered = this.state.answeredRows.reduce((a, r) => a + (r.llamadas || 0), 0);
        const raw = this.state.abandonedRowsRaw;
        const limpias = this.state.abandonedRows;

        const countByTurn = (arr, predicate) => ({
          dia: arr.filter(r => r.turno === 'dia' && (!predicate || predicate(r))).length,
          noche: arr.filter(r => r.turno === 'noche' && (!predicate || predicate(r))).length
        });
        
        const abandCleanByTurn = countByTurn(limpias);
        const dupByTurn = countByTurn(raw, r => r.isDuplicate);
        const lt20ByTurn = countByTurn(raw, r => r.isLT20);

        const totalAbandonedFinal = limpias.length;
        const totalIncoming = totalAnswered + totalAbandonedFinal;
        const serviceLevel = totalIncoming > 0 ? (totalAnswered / totalIncoming) * 100 : 0;
        const abandonoPct = totalIncoming > 0 ? (totalAbandonedFinal / totalIncoming) * 100 : 0;

        const dayContestadas = this.state.answeredRows
          .filter(r => this.turno(r.hora) === 'dia')
          .reduce((a, r) => a + (r.llamadas || 0), 0);
        
        const nightContestadas = this.state.answeredRows
          .filter(r => this.turno(r.hora) === 'noche')
          .reduce((a, r) => a + (r.llamadas || 0), 0);
        
        const dayRecibidas = dayContestadas + abandCleanByTurn.dia;
        const nightRecibidas = nightContestadas + abandCleanByTurn.noche;

        const transValid = this.state.transactionsRows;
        const transCC = transValid.filter(r => r.plataforma === 'Call Center');
        const transCCCount = transCC.length;
        const transDayCC = transCC.filter(r => this.turno(r.hora) === 'dia').length;
        const transNightCC = transCC.filter(r => this.turno(r.hora) === 'noche').length;

        const convCCGlobal = totalAnswered > 0 ? (transCCCount / totalAnswered) * 100 : 0;
        const convCCDay = dayContestadas > 0 ? (transDayCC / dayContestadas) * 100 : 0;
        const convCCNight = nightContestadas > 0 ? (transNightCC / nightContestadas) * 100 : 0;

        const dayPctAtencion = dayRecibidas > 0 ? (dayContestadas / dayRecibidas) * 100 : 0;
        const nightPctAtencion = nightRecibidas > 0 ? (nightContestadas / nightRecibidas) * 100 : 0;

        const byPlat = {};
        transValid.forEach(r => { 
          const k = r.plataforma || 'Sin plataforma'; 
          byPlat[k] = (byPlat[k] || 0) + 1; 
        });

        return {
          totalRecibidas: totalIncoming,
          totalContestadas: totalAnswered,
          totalAbandonadas: totalAbandonedFinal,
          serviceLevel: serviceLevel,
          abandonoPct: abandonoPct,
          transCCCount: transCCCount,
          convCCGlobal: convCCGlobal,

          day: {
            recibidas: dayRecibidas,
            contestadas: dayContestadas,
            trans: transDayCC,
            conv: convCCDay,
            abandonadas: abandCleanByTurn.dia,
            duplicadas: dupByTurn.dia,
            lt20: lt20ByTurn.dia,
            atencion: dayPctAtencion,
            abandonoPct: dayRecibidas > 0 ? (abandCleanByTurn.dia / dayRecibidas) * 100 : 0
          },
          night: {
            recibidas: nightRecibidas,
            contestadas: nightContestadas,
            trans: transNightCC,
            conv: convCCNight,
            abandonadas: abandCleanByTurn.noche,
            duplicadas: dupByTurn.noche,
            lt20: lt20ByTurn.noche,
            atencion: nightPctAtencion,
            abandonoPct: nightRecibidas > 0 ? (abandCleanByTurn.noche / nightRecibidas) * 100 : 0
          },

          byPlat: byPlat,
          answeredRows: this.state.answeredRows,
          abandonedRows: limpias
        };
      }

      // Data aggregation
      aggregateBySlot(answeredRows, abandonedRows) {
        const agg = new Map();
        const bucket = (slot) => { 
          if (!agg.has(slot)) agg.set(slot, {c: 0, connSum: 0, w: 0, a: 0, aConnSum: 0}); 
          return agg.get(slot); 
        };
        
        (answeredRows || []).forEach(r => {
          const slot = (r.periodo && this.slotFromPeriodo(r.periodo)) || this.periodo30(r.hora);
          const c = this.toNumber(r.llamadas);
          const t = this.toNumber(r.conexion);
          const b = bucket(slot);
          b.c += c; 
          b.connSum += t; b.w += (c || 0);
        });
        
        (abandonedRows || []).forEach(r => { 
          const slot = this.periodo30(r.hora); 
          const b = bucket(slot); 
          b.a += 1; 
          b.aConnSum += this.toNumber(r.conexion); 
        });
        
        const day = ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30'];
        const night = []; 
        for (let h = 16; h <= 23; h++) { 
          night.push(String(h).padStart(2, '0') + ':00'); 
          night.push(String(h).padStart(2, '0') + ':30'); 
        }
        
        const row = (slot) => {
          const x = agg.get(slot) || {c: 0, connSum: 0, w: 0, a: 0, aConnSum: 0};
          const contestadas = x.c | 0;
          const abandonadas = x.a | 0;
          const recibidas = contestadas + abandonadas;
          const avg = x.w > 0 ? (x.connSum / x.w) : 0;
          const aavg = abandonadas > 0 ? (x.aConnSum / abandonadas) : 0;
          const pctAt = recibidas > 0 ? (contestadas / recibidas) * 100 : 0;
          const pctAb = recibidas > 0 ? (abandonadas / recibidas) * 100 : 0;
          return { 
            hora: slot, 
            recibidas: recibidas, 
            contestadas: contestadas, 
            conexionSum: +x.connSum.toFixed(4),
            conexionAvg: +(x.w>0 ? (x.connSum/x.w) : 0).toFixed(1),
            pctAtencion: +pctAt.toFixed(2), 
            abandonadas: abandonadas, 
            abandConnSum: +x.aConnSum.toFixed(4),
            abandAvg: +(abandonadas>0 ? (x.aConnSum/abandonadas) : 0).toFixed(1), 
            pctAband: +pctAb.toFixed(2) 
          };
        };
        
        return { dia: day.map(row), noche: night.map(row) };
      }

      slotFromPeriodo(p) {
        if (!p) return null; 
        const s = String(p).trim();
        const m = s.match(/(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})/);
        if (!m) { 
          const mm = s.match(/^(\d{1,2}:\d{2})$/); 
          return mm ? mm[1] : null; 
        }
        return m[1].padStart(5, '0');
      }

      // UI Update methods
      updateKPIs(k) {
        document.getElementById('totalRecibidas').textContent = this.fmt(k.totalRecibidas);
        document.getElementById('totalContestadas').textContent = this.fmt(k.totalContestadas);
        document.getElementById('totalAbandonadas').textContent = this.fmt(k.totalAbandonadas);
        document.getElementById('nivelServicio').textContent = this.safeFixed(k.serviceLevel, 1) + '%';
        document.getElementById('porcAbandono').textContent = this.safeFixed(k.abandonoPct, 1) + '%';
        document.getElementById('transCc').textContent = this.fmt(k.transCCCount);
        document.getElementById('porcConversionCC').textContent = this.safeFixed(k.convCCGlobal, 1) + '%';

        // Day shift
        document.getElementById('dayRecibidas').textContent = this.fmt(k.day.recibidas);
        document.getElementById('dayContestadas').textContent = this.fmt(k.day.contestadas);
        document.getElementById('dayTransCC').textContent = this.fmt(k.day.trans);
        document.getElementById('dayConvCC').textContent = this.safeFixed(k.day.conv, 1) + '%';
        document.getElementById('dayAbandonadas').textContent = this.fmt(k.day.abandonadas);
        document.getElementById('dayDuplicadas').textContent = this.fmt(k.day.duplicadas);
        document.getElementById('dayLT20').textContent = this.fmt(k.day.lt20);
        document.getElementById('dayPctAtencion').textContent = this.safeFixed(k.day.atencion, 1) + '%';
        document.getElementById('dayPctAbandono').textContent = this.safeFixed(k.day.abandonoPct, 1) + '%';

        // Night shift
        document.getElementById('nightRecibidas').textContent = this.fmt(k.night.recibidas);
        document.getElementById('nightContestadas').textContent = this.fmt(k.night.contestadas);
        document.getElementById('nightTransCC').textContent = this.fmt(k.night.trans);
        document.getElementById('nightConvCC').textContent = this.safeFixed(k.night.conv, 1) + '%';
        document.getElementById('nightAbandonadas').textContent = this.fmt(k.night.abandonadas);
        document.getElementById('nightDuplicadas').textContent = this.fmt(k.night.duplicadas);
        document.getElementById('nightLT20').textContent = this.fmt(k.night.lt20);
        document.getElementById('nightPctAtencion').textContent = this.safeFixed(k.night.atencion, 1) + '%';
        document.getElementById('nightPctAbandono').textContent = this.safeFixed(k.night.abandonoPct, 1) + '%';
      }

      // Chart drawing methods
      safeCtx(id) { 
        const el = document.getElementById(id); 
        return el && el.getContext ? el.getContext('2d') : null; 
      }

      drawCharts(kpis, grouped) {
        this.drawTurnoChart(kpis);
        this.drawPlataformaChart(kpis);
        this.drawSucursalesChart();
        this.renderTables(grouped);
      }

      drawTurnoChart(kpis) {
        const ctxA = this.safeCtx('barsTurno');
        if (!ctxA) return;
        
        if (this.state.charts.turno) { 
          this.state.charts.turno.destroy(); 
        }
        
        const attDia = +kpis.day.atencion.toFixed(2);
        const attNoc = +kpis.night.atencion.toFixed(2);
        const abandPctDia = kpis.day.recibidas > 0 ? +((kpis.day.abandonadas / kpis.day.recibidas) * 100).toFixed(2) : 0;
        const abandPctNoc = kpis.night.recibidas > 0 ? +((kpis.night.abandonadas / kpis.night.recibidas) * 100).toFixed(2) : 0;
        
        this.state.charts.turno = new Chart(ctxA, {
          type: 'bar',
          data: {
            labels: ['D√≠a', 'Noche'], 
            datasets: [
              {
                label: '% Atenci√≥n', 
                data: [attDia, attNoc], 
                backgroundColor: '#16a34a', 
                borderRadius: 4, 
                borderSkipped: false
              },
              {
                label: '% Abandono', 
                data: [abandPctDia, abandPctNoc], 
                backgroundColor: '#dc2626', 
                borderRadius: 4, 
                borderSkipped: false
              }
            ]
          },
          options: {
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: {
              legend: {
                position: 'top'
              }
            }, 
            scales: {
              y: {
                beginAtZero: true, 
                max: 100, 
                grid: {
                  color: '#e5e7eb'
                }
              }, 
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }

      drawPlataformaChart(kpis) {
        const ctxC = this.safeCtx('barsPlataforma');
        if (!ctxC) return;
        
        if (this.state.charts.plataforma) { 
          this.state.charts.plataforma.destroy(); 
        }
        
        const labelsP = Object.keys(kpis.byPlat);
        const valuesP = labelsP.map(k => kpis.byPlat[k]);
        
        this.state.charts.plataforma = new Chart(ctxC, {
          type: 'bar',
          data: {
            labels: labelsP, 
            datasets: [
              {
                label: '√ìrdenes v√°lidas', 
                data: valuesP, 
                backgroundColor: '#2563eb', 
                borderRadius: 4, 
                borderSkipped: false
              }
            ]
          },
          options: {
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: {
              legend: {
                display: false
              }
            }, 
            scales: {
              y: {
                beginAtZero: true, 
                grid: {
                  color: '#e5e7eb'
                }
              }, 
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }

      drawHourly(grouped) {
        const hctx = this.safeCtx('barHora'); 
        if (!hctx) return;
        
        const slots = this.state.hourTurn === 'dia' ? grouped.dia : grouped.noche;
        if (this.state.charts.hora) { 
          this.state.charts.hora.destroy(); 
        }
        
        const labels = slots.map(s => s.hora);
        const recibidas = slots.map(s => s.recibidas);
        const contestadas = slots.map(s => s.contestadas);
        const abandonadas = slots.map(s => s.abandonadas);
        
        this.state.charts.hora = new Chart(hctx, {
          type: 'bar',
          data: { 
            labels: labels, 
            datasets: [
              {
                label: 'Recibidas', 
                data: recibidas, 
                backgroundColor: '#0f172a', 
                borderRadius: 3, 
                borderSkipped: false
              },
              {
                label: 'Contestadas', 
                data: contestadas, 
                backgroundColor: '#6b7280', 
                borderRadius: 3, 
                borderSkipped: false
              },
              {
                label: 'Abandonadas', 
                data: abandonadas, 
                backgroundColor: '#ef4444', 
                borderRadius: 3, 
                borderSkipped: false
              }
            ]
          },
          options: {
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: {
              legend: {
                position: 'top'
              }
            },
            scales: {
              x: {
                stacked: false, 
                grid: {
                  display: false
                }
              }, 
              y: {
                stacked: false, 
                beginAtZero: true, 
                grid: {
                  color: '#e5e7eb'
                }
              }
            }
          }
        });
      }

      drawSalesChart() {
        const ctx = this.safeCtx('barVentas'); 
        if (!ctx) return;
        if (this.state.charts.ventas) { 
          this.state.charts.ventas.destroy(); 
        }

        if (this.state.salesMode === 'agg') {
          const sales = this.salesTotalsCCvsRest();
          this.state.charts.ventas = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['Call Center', 'Resto plataformas'],
              datasets: [
                {
                  label: 'Ventas totales', 
                  data: [sales.cc, sales.rest],
                  backgroundColor: ['#111827', '#6b7280'], 
                  borderRadius: 4, 
                  borderSkipped: false
                }
              ]
            },
            options: {
              responsive: true, 
              maintainAspectRatio: false, 
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true, 
                  grid: {
                    color: '#e5e7eb'
                  }
                }, 
                x: {
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        } else {
          const byP = this.salesByPlatform();
          this.state.charts.ventas = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: byP.labels,
              datasets: [
                {
                  label: 'Ventas por plataforma', 
                  data: byP.values,
                  backgroundColor: '#374151', 
                  borderRadius: 4, 
                  borderSkipped: false
                }
              ]
            },
            options: {
              responsive: true, 
              maintainAspectRatio: false, 
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true, 
                  grid: {
                    color: '#e5e7eb'
                  }
                }, 
                x: {
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }
      }

      drawAOVChart() {
        const ctx = this.safeCtx('barAOV'); 
        if (!ctx) return;
        if (this.state.charts.aov) { 
          this.state.charts.aov.destroy(); 
        }

        if (this.state.aovMode === 'agg') {
          const aov = this.aovCCvsRest();
          this.state.charts.aov = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['Call Center', 'Resto plataformas'],
              datasets: [
                {
                  label: 'Ticket promedio', 
                  data: [+aov.cc.toFixed(2), +aov.rest.toFixed(2)],
                  backgroundColor: ['#b91c1c', '#2563eb'], 
                  borderRadius: 4, 
                  borderSkipped: false
                }
              ]
            },
            options: {
              responsive: true, 
              maintainAspectRatio: false, 
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true, 
                  grid: {
                    color: '#e5e7eb'
                  }
                }, 
                x: {
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        } else {
          const byP = this.aovByPlatform();
          this.state.charts.aov = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: byP.labels,
              datasets: [
                {
                  label: 'AOV por plataforma', 
                  data: byP.values.map(v => +v.toFixed(2)),
                  backgroundColor: '#2563eb', 
                  borderRadius: 4, 
                  borderSkipped: false
                }
              ]
            },
            options: {
              responsive: true, 
              maintainAspectRatio: false, 
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true, 
                  grid: {
                    color: '#e5e7eb'
                  }
                }, 
                x: {
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }
      }

      drawSucursalesChart() {
        const sucCtx = this.safeCtx('barSucursalesCC');
        if (!sucCtx) return;
        
        if (this.state.charts.sucursales) { 
          this.state.charts.sucursales.destroy(); 
        }
        
        const top = this.topBranchesCC(10);
        this.state.charts.sucursales = new Chart(sucCtx, {
          type: 'bar',
          data: { 
            labels: top.labels, 
            datasets: [
              { 
                label: 'Transacciones CC', 
                data: top.values, 
                backgroundColor: '#b91c1c', 
                borderRadius: 4, 
                borderSkipped: false 
              }
            ] 
          },
          options: {
            indexAxis: 'y', 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { 
              legend: { 
                display: false 
              } 
            },
            scales: { 
              x: { 
                beginAtZero: true, 
                grid: { 
                  color: '#e5e7eb' 
                } 
              }, 
              y: { 
                grid: { 
                  display: false 
                } 
              } 
            }
          }
        });
      }

      renderTables(grouped) {
        this.renderTable('dayTableBody', grouped.dia);
        this.renderTable('nightTableBody', grouped.noche);
      }

      renderTable(tbodyId, slots) {
        const tb = document.getElementById(tbodyId); 
        if (!tb) return; 
        tb.innerHTML = '';
        
        slots.forEach(s => {
          const pctAt = +Number(s.pctAtencion).toFixed(1);
          const pctAb = +Number(s.pctAband).toFixed(1);
          const clsAt = this.heatClassAtencion(pctAt);
          const clsAb = this.heatClassAbandono(pctAb);

          const tr = document.createElement('tr');
          tr.innerHTML =
            `<td class="time-cell">${s.hora}</td>` +
            `<td>${this.fmt(s.recibidas)}</td>` +
            `<td>${this.fmt(s.contestadas)}</td>` +
            `<td>${this.safeFixed(s.conexionSum, 4)}</td>` +
            `<td>${this.safeFixed(s.conexionAvg, 1)}</td>` +
            `<td class="${clsAt}">${pctAt.toFixed(1)}%</td>` +
            `<td>${this.fmt(s.abandonadas)}</td>` +
            `<td>${this.safeFixed(s.abandConnSum, 4)}</td>` +
            `<td>${this.safeFixed(s.abandAvg, 1)}</td>` +
            `<td class="${clsAb}">${pctAb.toFixed(1)}%</td>`;
          tb.appendChild(tr);
        });
      }

      // Heat map helpers
      heatClassAtencion(p) { 
        if (p >= 90) return 'heat-good'; 
        if (p >= 80) return 'heat-warn'; 
        return 'heat-bad'; 
      }
      
      heatClassAbandono(p) { 
        if (p <= 5) return 'heat-good'; 
        if (p <= 10) return 'heat-warn'; 
        return 'heat-bad'; 
      }

      // Platform analysis methods
      salesTotalsCCvsRest() {
        const cc = this.state.transactionsRows.filter(t => t.plataforma === 'Call Center');
        const rest = this.state.transactionsRows.filter(t => t.plataforma !== 'Call Center');
        const sum = (a, b) => a + (b.valor || 0);
        return { cc: cc.reduce(sum, 0), rest: rest.reduce(sum, 0) };
      }
      
      aovCCvsRest() {
        const cc = this.state.transactionsRows.filter(t => t.plataforma === 'Call Center');
        const rest = this.state.transactionsRows.filter(t => t.plataforma !== 'Call Center');
        const sum = (a, b) => a + (b.valor || 0);
        const scc = cc.reduce(sum, 0);
        const src = rest.reduce(sum, 0);
        return { cc: cc.length ? scc / cc.length : 0, rest: rest.length ? src / rest.length : 0 };
      }
      
      salesByPlatform() {
        const map = new Map();
        this.state.transactionsRows.forEach(t => {
          const p = t.plataforma || 'Sin plataforma';
          map.set(p, (map.get(p) || 0) + (t.valor || 0));
        });
        const order = this.platformsOrder();
        const labels = order.filter(l => map.has(l));
        const values = labels.map(l => map.get(l));
        return { labels, values };
      }
      
      aovByPlatform() {
        const sum = new Map();
        const count = new Map();
        this.state.transactionsRows.forEach(t => {
          const p = t.plataforma || 'Sin plataforma';
          sum.set(p, (sum.get(p) || 0) + (t.valor || 0));
          count.set(p, (count.get(p) || 0) + 1);
        });
        const order = this.platformsOrder();
        const labels = order.filter(l => count.has(l));
        const values = labels.map(l => count.get(l) ? (sum.get(l) / count.get(l)) : 0);
        return { labels, values };
      }
      
      topBranchesCC(limit = 10) {
        const map = {};
        this.state.transactionsRows.forEach(t => {
          if (t.plataforma !== 'Call Center') return;
          const s = t.sucursal || 'Sin sucursal';
          map[s] = (map[s] || 0) + 1;
        });
        const arr = Object.entries(map).sort((a, b) => b[1] - a[1]).slice(0, limit);
        return { labels: arr.map(x => x[0]), values: arr.map(x => x[1]) };
      }

      platformsOrder() { 
        return ['Call Center', 'App', 'WhatsApp', 'Web', 'Agregadores']; 
      }

      // Audit functionality
      auditTransacciones(todas, validas) {
        const el = document.getElementById('auditContent'); 
        if (!el) return;

        const fechas = [];
        (validas || []).forEach(r => { 
          if (r.fecha) fechas.push(new Date(r.fecha)); 
        });
        
        let rango = '-'; 
        if (fechas.length) { 
          const ms = fechas.map(d => +d);
          const min = new Date(Math.min(...ms));
          const max = new Date(Math.max(...ms));
          rango = min.toISOString().slice(0, 10) + ' a ' + max.toISOString().slice(0, 10); 
        }

        const byEstatus = {};
        const byPlat = {};
        const byCanalReal = {};
        const valores = [];
        
        (todas || []).forEach(r => { 
          const k = r.estatus || '-'; 
          byEstatus[k] = (byEstatus[k] || 0) + 1; 
        });
        
        (validas || []).forEach(r => {
          const p = r.plataforma || 'Sin plataforma'; 
          byPlat[p] = (byPlat[p] || 0) + 1;
          const c = r.canalReal || ''; 
          byCanalReal[c] = (byCanalReal[c] || 0) + 1;
          if (typeof r.valor === 'number' && !isNaN(r.valor)) valores.push(r.valor);
        });

        const totalValor = (validas || []).reduce((a, r) => a + (r.valor || 0), 0);
        const aovGlobal = (validas && validas.length) ? totalValor / validas.length : 0;
        const aovByPlat = {};
        
        Object.keys(byPlat).forEach(p => {
          const arr = validas.filter(r => (r.plataforma || 'Sin plataforma') === p);
          const sum = arr.reduce((a, r) => a + (r.valor || 0), 0);
          aovByPlat[p] = arr.length ? (sum / arr.length) : 0;
        });

        const table = (obj) => {
          const rows = Object.entries(obj).sort((a, b) => b[1] - a[1])
            .map(x => `<tr><td style="padding:4px 8px;border-bottom:1px solid #eee;">${x[0]}</td><td style="padding:4px 8px;border-bottom:1px solid #eee;text-align:right;">${x[1]}</td></tr>`)
            .join('');
          return `<table style="border-collapse:collapse;width:100%;max-width:560px;margin:6px 0 12px 0;"><tbody>${rows}</tbody></table>`;
        };

        const tableAOV = (obj) => {
          const rows = Object.entries(obj).sort((a, b) => b[1] - a[1])
            .map(x => `<tr><td style="padding:4px 8px;border-bottom:1px solid #eee;">${x[0]}</td><td style="padding:4px 8px;border-bottom:1px solid #eee;text-align:right;">${x[1].toFixed(2)}</td></tr>`)
            .join('');
          return `<table style="border-collapse:collapse;width:100%;max-width:560px;margin:6px 0 12px 0;"><tbody>${rows}</tbody></table>`;
        };

        el.innerHTML = ''
          + `<div><b>Rango detectado:</b> ${rango}</div>`
          + `<div style="margin-top:8px;"><b>Registros v√°lidos (estatus != A):</b> ${(validas || []).length}</div>`
          + `<div style="margin-top:12px;"><b>Plataformas (v√°lidas):</b>${table(byPlat)}</div>`
          + `<div><b>Canal real:</b>${table(byCanalReal)}</div>`
          + `<div style="margin-top:12px;"><b>Monto total:</b> ${totalValor.toFixed(2)} | <b>Ticket global:</b> ${aovGlobal.toFixed(2)}</div>`
          + `<div><b>Ticket por plataforma:</b>${tableAOV(aovByPlat)}</div>`;
      }

      // Export functionality
      buildTablesForExport() {
        const k = this.calculateKPIs();
        const g = this.state.lastGrouped || this.aggregateBySlot(k.answeredRows, k.abandonedRows);

        
        const sumTurn = (slots) => {
          let rec = 0, con = 0, aba = 0;
          (slots || []).forEach(s => { rec += (s.recibidas||0); con += (s.contestadas||0); aba += (s.abandonadas||0); });
          const at = rec > 0 ? (con/rec)*100 : 0;
          return {rec, con, aba, at, ab: 100 - at};
        };
        const day = sumTurn(g.dia);
        const night = sumTurn(g.noche);

        const kpiRows = () => [
          ['KPI','Global','D√≠a','Noche'],
          ['Total Recibidas', k.totalRecibidas, day.rec, night.rec],
          ['Total Contestadas', k.totalContestadas, day.con, night.con],
          ['Total Abandonadas', k.totalAbandonadas, day.aba, night.aba],
          ['% Atenci√≥n', +k.serviceLevel.toFixed(1), +day.at.toFixed(1), +night.at.toFixed(1)],
          ['% Abandono', +k.abandonoPct.toFixed(1), +day.ab.toFixed(1), +night.ab.toFixed(1)],
          ['Transacciones CC', k.transCCCount, '', ''],
          ['% Conversi√≥n CC', +k.convCCGlobal.toFixed(1), '', '']
        ];

        
        const tableFromSlots = (slots) => { const rows = [['Hora','Recibidas','Contestadas','Conexi√≥n','AVG time','% Atenci√≥n','Abandonadas','Conexi√≥n','AVG time Aband.','% Abandono']];
          slots.forEach(s => {
            rows.push([s.hora, s.recibidas, s.contestadas, (+Number(s.conexionSum).toFixed(4)).toString(), (+Number(s.conexionAvg).toFixed(1)).toString(), (Number(s.pctAtencion).toFixed(2) + '%'), s.abandonadas, (+Number(s.abandConnSum).toFixed(4)).toString(), (+Number(s.abandAvg).toFixed(1)).toString(), (Number(s.pctAband).toFixed(2) + '%')]);
          });
          return rows;
        };

        const salesAgg = this.salesTotalsCCvsRest();
        const aovAgg = this.aovCCvsRest();
        const salesPlat = this.salesByPlatform();
        const aovPlat = this.aovByPlatform();

        const ventasRows = [['Categor√≠a', 'Valor']];
        ventasRows.push(['Call Center', salesAgg.cc], ['Resto plataformas', salesAgg.rest]);
        salesPlat.labels.forEach((l, i) => { 
          ventasRows.push([l, salesPlat.values[i]]); 
        });

        const aovRows = [['Categor√≠a', 'AOV']];
        aovRows.push(['Call Center', +aovAgg.cc.toFixed(2)], ['Resto plataformas', +aovAgg.rest.toFixed(2)]);
        aovPlat.labels.forEach((l, i) => { 
          aovRows.push([l, +aovPlat.values[i].toFixed(2)]); 
        });

        return {
          KPIs: kpiRows(),
          Dia: tableFromSlots(g.dia),
          Noche: tableFromSlots(g.noche),
          Ventas: ventasRows,
          AOV: aovRows
        };
      }

      exportCSV() {
        const t = this.buildTablesForExport();
        const toCSV = (rows) => {
          return rows.map(r => { 
            return r.map(x => {
              const s = (x == null ? '' : String(x));
              if (/[",;\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
              return s;
            }).join(','); 
          }).join('\n');
        };
        
        const parts = [];
        parts.push('KPIs', toCSV(t.KPIs), '');
        parts.push('Turno D√≠a', toCSV(t.Dia), '');
        parts.push('Turno Noche', toCSV(t.Noche), '');
        parts.push('Ventas', toCSV(t.Ventas), '');
        parts.push('AOV', toCSV(t.AOV));
        
        const blob = new Blob([parts.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'reporte_callcenter.csv';
        document.body.appendChild(a); 
        a.click(); 
        a.remove();
        this.showStatus('CSV exportado', 'success');
      }

      exportXLSX() {
        const t = this.buildTablesForExport();
        const wb = XLSX.utils.book_new();
        
        const sheet = (name, rows) => {
          const ws = XLSX.utils.aoa_to_sheet(rows);
          XLSX.utils.book_append_sheet(wb, ws, name.slice(0, 31));
        };
        
        sheet('KPIs', t.KPIs);
        sheet('Dia', t.Dia);
        sheet('Noche', t.Noche);
        sheet('Ventas', t.Ventas);
        sheet('AOV', t.AOV);
        
        XLSX.writeFile(wb, 'reporte_callcenter.xlsx');
        this.showStatus('Excel exportado', 'success');
      }
    }

    // Initialize the dashboard when DOM is ready
    const dashboard = new Dashboard();

    // Global error handling
    window.addEventListener('error', (e) => {
      console.error('Global Error:', e);
      const alertsContainer = document.getElementById('alertsContainer');
      if (alertsContainer) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger';
        alert.innerHTML = `<span class="alert-icon">‚ö†Ô∏è</span><span>Error: ${e.message}</span>`;
        alertsContainer.prepend(alert);
        setTimeout(() => alert.remove(), 10000);
      }
    });
  </script>
</body>
</html>